{% extends "base.html" %} {% block title %}Dropbox Upload to Cloudinary -
Bazarchic DB Tool{% endblock %} {% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h1 class="text-2xl font-bold text-gray-800">
      <i class="fab fa-dropbox text-dropbox mr-2"></i>Upload Dropbox Images to
      Cloudinary
    </h1>
    <p class="text-gray-600 mt-2">
      Upload images directly from Dropbox to Cloudinary without local download
    </p>
  </div>

  <!-- Upload Form -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <form
      method="POST"
      action="{{ url_for('cloudinary.dropbox_upload') }}"
      id="uploadForm"
    >
      <!-- Folder Selection Method -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-3"
          >Folder Selection Method</label
        >
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="cursor-pointer">
            <input
              type="radio"
              name="selection_method"
              value="dropdown"
              {% if folders and folders|length > 0 %}checked{% endif %}
              class="peer sr-only"
            />
            <div
              class="border-2 {% if folders and folders|length > 0 %}border-primary bg-blue-50{% else %}border-gray-300{% endif %} peer-checked:border-primary peer-checked:bg-blue-50 rounded-xl p-4 hover:bg-blue-100 transition-all duration-300 shadow-sm hover:shadow-md"
            >
              <div class="flex items-center">
                <div
                  class="flex items-center justify-center w-10 h-10 bg-blue-100 rounded-lg mr-3"
                >
                  <i class="fas fa-list text-primary text-xl"></i>
                </div>
                <div>
                  <p class="font-semibold text-gray-800">Select from List</p>
                  <p class="text-sm text-gray-600 mt-1">
                    Choose from available folders
                  </p>
                </div>
              </div>
            </div>
          </label>

          <label class="cursor-pointer">
            <input
              type="radio"
              name="selection_method"
              value="manual"
              {% if not folders or folders|length == 0 %}checked{% endif %}
              class="peer sr-only"
            />
            <div
              class="border-2 {% if not folders or folders|length == 0 %}border-primary bg-blue-50{% else %}border-gray-300{% endif %} peer-checked:border-primary peer-checked:bg-blue-50 rounded-xl p-4 hover:bg-blue-100 transition-all duration-300 shadow-sm hover:shadow-md"
            >
              <div class="flex items-center">
                <div
                  class="flex items-center justify-center w-10 h-10 bg-blue-100 rounded-lg mr-3"
                >
                  <i class="fas fa-keyboard text-primary text-xl"></i>
                </div>
                <div>
                  <p class="font-semibold text-gray-800">Manual Entry</p>
                  <p class="text-sm text-gray-600 mt-1">Type folder path</p>
                </div>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Dropbox Folder Selection -->
      <div class="mb-6" id="dropdownSelection">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <i class="fab fa-dropbox text-purple-600 mr-1"></i>Select Dropbox
          Folder
        </label>
        {% if error %}
        <div class="mb-4 bg-red-50 border border-red-200 rounded-lg p-4">
          <p class="text-red-600 text-sm">
            <i class="fas fa-exclamation-circle mr-1"></i>
            Error loading folders: {{ error }}
          </p>
        </div>
        {% endif %} {% if folders and folders|length > 0 %}
        <select
          name="dropbox_path"
          id="folderDropdown"
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-300"
        >
          <option value="">-- Select a folder --</option>
          {% for folder in folders %}
          <option value="{{ folder }}">{{ folder }}</option>
          {% endfor %}
        </select>
        <p class="text-sm text-gray-500 mt-2">
          <i class="fas fa-info-circle mr-1"></i>
          Found {{ folders|length }} folders in your Dropbox
        </p>
        {% else %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <p class="text-yellow-800 text-sm">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            No folders found in Dropbox or unable to connect. Please use manual
            entry.
          </p>
        </div>
        {% endif %}
      </div>

      <!-- Manual Path Input -->
      <div
        class="mb-6 {% if folders and folders|length > 0 %}hidden{% endif %}"
        id="manualInput"
      >
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Dropbox Folder Path</label
        >
        <input
          type="text"
          name="dropbox_path_manual"
          id="manualPath"
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-dropbox focus:border-dropbox transition-all duration-300"
          placeholder="e.g., /my_images or /photos/products"
        />
        <p class="text-sm text-gray-500 mt-2">
          <i class="fas fa-info-circle mr-1"></i>
          Path must start with / (e.g., /my_images)
        </p>
      </div>

      <!-- Thread Count -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Concurrent Threads</label
        >
        <input
          type="number"
          name="max_workers"
          value="10"
          min="1"
          max="20"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
        />
        <p class="text-sm text-gray-500 mt-2">
          Number of concurrent upload threads (recommended: 5-15)
        </p>
      </div>

      <!-- Cloudinary Folder Name -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Cloudinary Folder Name (Optional)</label
        >
        <input
          type="text"
          name="cloudinary_folder"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
          placeholder="Leave empty to use default folder"
        />
        <p class="text-sm text-gray-500 mt-2">
          Custom folder name in Cloudinary (default: bazarchic_images)
        </p>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        id="submitBtn"
        class="w-full bg-primary hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-[1.02] hover:shadow-xl flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:hover:shadow-none"
      >
        <i class="fas fa-cloud-upload-alt mr-3 text-lg" id="submitIcon"></i>
        <span id="submitText" class="text-lg">Start Upload</span>
      </button>
    </form>
  </div>

  <!-- Progress Container (Hidden by default) -->
  <div id="progressContainer" class="bg-white rounded-lg shadow-md p-6 hidden">
    <h2 class="text-lg font-bold text-gray-800 mb-4">
      <i class="fas fa-spinner fa-spin text-purple-600 mr-2"></i>Upload Progress
    </h2>
    <div class="mb-4">
      <div class="flex justify-between text-sm text-gray-600 mb-2">
        <span>Progress</span>
        <span id="progressPercentage">0%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div
          id="progressBar"
          class="bg-gradient-to-r from-purple-600 to-pink-600 h-4 rounded-full transition-all duration-300"
          style="width: 0%"
        ></div>
      </div>
    </div>
    <div
      id="progressLog"
      class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto"
    >
      <p class="text-sm text-gray-600">Initializing upload...</p>
    </div>
  </div>

  <!-- Info Panel -->
  <div
    class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg shadow-md p-6 border border-purple-200"
  >
    <h2 class="text-lg font-bold text-gray-800 mb-4">
      <i class="fas fa-info-circle text-purple-600 mr-2"></i>How It Works
    </h2>
    <div class="space-y-3 text-gray-700">
      <p class="flex items-start">
        <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
        <span
          ><strong>Direct Transfer:</strong> Images transfer from Dropbox to
          Cloudinary without local download</span
        >
      </p>
      <p class="flex items-start">
        <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
        <span
          ><strong>Temporary Links:</strong> Uses Dropbox temporary links (valid
          for 4 hours)</span
        >
      </p>
      <p class="flex items-start">
        <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
        <span
          ><strong>Multi-threaded:</strong> Fast parallel uploads with
          configurable thread count</span
        >
      </p>
      <p class="flex items-start">
        <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
        <span
          ><strong>Supported Formats:</strong> JPG, JPEG, PNG, GIF, BMP, WEBP,
          SVG</span
        >
      </p>
      <p class="flex items-start">
        <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
        <span
          ><strong>CSV Export:</strong> Downloads a CSV file with filenames and
          Cloudinary URLs</span
        >
      </p>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById("uploadForm");
  const submitBtn = document.getElementById("submitBtn");
  const submitIcon = document.getElementById("submitIcon");
  const submitText = document.getElementById("submitText");
  const progressContainer = document.getElementById("progressContainer");
  const selectionMethodRadios = document.querySelectorAll(
    'input[name="selection_method"]'
  );
  const dropdownSelection = document.getElementById("dropdownSelection");
  const manualInput = document.getElementById("manualInput");
  const folderDropdown = document.getElementById("folderDropdown");
  const manualPath = document.getElementById("manualPath");

  // Handle selection method toggle
  selectionMethodRadios.forEach((radio) => {
    radio.addEventListener("change", function () {
      if (this.value === "dropdown") {
        dropdownSelection.classList.remove("hidden");
        manualInput.classList.add("hidden");
        if (folderDropdown) folderDropdown.required = true;
        manualPath.required = false;
        manualPath.value = "";
      } else {
        dropdownSelection.classList.add("hidden");
        manualInput.classList.remove("hidden");
        if (folderDropdown) folderDropdown.required = false;
        manualPath.required = true;
      }
    });
  });

  form.addEventListener("submit", function (e) {
    // Get the active selection method
    const activeMethod = document.querySelector(
      'input[name="selection_method"]:checked'
    ).value;

    // If manual entry is selected, copy the manual path to the main dropbox_path field
    if (activeMethod === "manual") {
      const hiddenInput = document.createElement("input");
      hiddenInput.type = "hidden";
      hiddenInput.name = "dropbox_path";
      hiddenInput.value = manualPath.value;
      form.appendChild(hiddenInput);
    }

    // Show progress container
    progressContainer.classList.remove("hidden");

    // Disable submit button
    submitBtn.disabled = true;
    submitIcon.className = "fas fa-spinner fa-spin mr-2";
    submitText.textContent = "Uploading...";

    // Scroll to progress container
    progressContainer.scrollIntoView({ behavior: "smooth", block: "center" });
  });
</script>
{% endblock %}
